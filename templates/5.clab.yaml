name: linux-bridge-intervlan

topology:
  nodes:
    br:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache bridge-utils iproute2 vlan tcpdump

        # VLAN-aware bridge
        - ip link add br0 type bridge vlan_filtering 1
        - ip link set br0 up

        # Attach ports
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip link set eth4 master br0
        - ip link set eth5 master br0

        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        - ip link set eth5 up

        # VLANs on bridge itself (CRITICAL)
        - bridge vlan add vid 10 dev br0 self
        - bridge vlan add vid 20 dev br0 self

        # VLAN 10 access ports
        - bridge vlan add vid 10 dev eth1 pvid untagged
        - bridge vlan add vid 10 dev eth2 pvid untagged

        # VLAN 20 access ports
        - bridge vlan add vid 20 dev eth3 pvid untagged
        - bridge vlan add vid 20 dev eth4 pvid untagged

        # Trunk to router (TAGGED)
        - bridge vlan add vid 10 dev eth5 tagged
        - bridge vlan add vid 20 dev eth5 tagged

    r1:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils vlan
        - sysctl -w net.ipv4.ip_forward=1

        # Bring physical up first
        - ip link set eth1 up

        # VLAN subinterfaces
        - ip link add link eth1 name eth1.10 type vlan id 10
        - ip link add link eth1 name eth1.20 type vlan id 20

        - ip addr add 192.168.10.254/24 dev eth1.10
        - ip addr add 192.168.20.254/24 dev eth1.20

        - ip link set eth1.10 up
        - ip link set eth1.20 up

    host1:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils
        - ip addr add 192.168.10.1/24 dev eth1
        - ip route add default via 192.168.10.254
        - ip link set eth1 up

    host2:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils
        - ip addr add 192.168.10.2/24 dev eth1
        - ip route add default via 192.168.10.254
        - ip link set eth1 up

    host3:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils
        - ip addr add 192.168.20.1/24 dev eth1
        - ip route add default via 192.168.20.254
        - ip link set eth1 up

    host4:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils
        - ip addr add 192.168.20.2/24 dev eth1
        - ip route add default via 192.168.20.254
        - ip link set eth1 up

  links:
    - endpoints: ["host1:eth1", "br:eth1"]
    - endpoints: ["host2:eth1", "br:eth2"]
    - endpoints: ["host3:eth1", "br:eth3"]
    - endpoints: ["host4:eth1", "br:eth4"]
    - endpoints: ["r1:eth1", "br:eth5"]
